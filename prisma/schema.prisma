generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  USER
  GUEST
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String    @db.VarChar(255)
  image         String?
  role          Role      @default(USER)
  storageQuota  Int       @default(104857600) // 100MB in bytes
  usedStorage   Int       @default(0) // Used storage in bytes
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts     Account[]
  sessions     Session[]
  secondFactor SecondFactor?
  auditLogs    AuditLog[]
  files        File[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  oauth_token_secret String?
  oauth_token         String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
}

enum SecondFactorType {
  TOTP
  WEBAUTHN
}

model SecondFactor {
  id            String           @id @default(cuid())
  userId        String           @unique
  type          SecondFactorType @default(TOTP)
  // Encrypted TOTP secret (AES-256-GCM encrypted)
  secret        String?          @db.Text
  // Backup codes stored as hashed values (bcrypt)
  backupCodes   String[]         @default([])
  // Whether 2FA is enabled and verified
  enabled       Boolean          @default(false)
  // Whether setup is in progress (user generated QR but hasn't verified yet)
  setupComplete Boolean          @default(false)
  // Last successful verification timestamp (for rate limiting)
  lastVerifiedAt DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum AuditAction {
  // Authentication events
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  REGISTER
  // 2FA events
  TWO_FACTOR_SETUP
  TWO_FACTOR_VERIFY_SUCCESS
  TWO_FACTOR_VERIFY_FAILED
  TWO_FACTOR_DISABLED
  BACKUP_CODE_USED
  // Authorization events
  ROLE_CHANGED
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  // File operations (for future use)
  FILE_UPLOADED
  FILE_DOWNLOADED
  FILE_DELETED
  FILE_SHARED
  FILE_SHARE_REVOKED
  // Administrative events
  USER_CREATED
  USER_DELETED
  USER_BLOCKED
  USER_UNBLOCKED
  POLICY_CHANGED
  // System events
  RATE_LIMIT_EXCEEDED
  SUSPICIOUS_ACTIVITY
}

model File {
  id            String   @id @default(cuid())
  userId        String
  name          String
  path          String   // Path in local storage
  size          Int      // Size in bytes
  mimeType      String
  hash          String   // SHA-256 hash for integrity verification
  encrypted     Boolean  @default(true)
  encryptionKey String   @db.Text // Encrypted file encryption key
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user    User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares  FileShare[]

  @@index([userId])
  @@index([userId, createdAt])
}

enum SharePermission {
  READ
  READ_WRITE
}

model FileShare {
  id         String          @id @default(cuid())
  fileId     String
  sharedBy   String          // userId власника
  sharedWith String?         // userId або null для публічних
  permission SharePermission @default(READ)
  token      String?         @unique // Для публічних посилань
  expiresAt  DateTime?
  createdAt  DateTime        @default(now())

  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([sharedWith])
  @@index([token])
  @@index([expiresAt])
}

model StepUpSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?     // Nullable for system events or unauthenticated actions
  action    AuditAction
  success   Boolean     @default(true) // Whether the action succeeded
  ipAddress String?     // IP address of the client
  userAgent String?     // User agent string
  metadata  String?     @db.Text // Additional JSON metadata (error messages, details)
  createdAt DateTime    @default(now())

  // Optional relation to user (for easier queries)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

